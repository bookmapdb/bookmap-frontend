<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>도서 리스트</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #fafafa; color: #333; }
    h1 { text-align: center; }

    /* 버튼 */
    .toolbar { text-align: center; margin-bottom: 20px; }
    .toolbar button {
      margin: 5px; padding: 8px 14px; border: none;
      background: #1a73e8; color: white; border-radius: 6px; cursor: pointer;
    }
    .toolbar button:hover { background: #1558b0; }

    /* 도서 카드 */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap: 16px; }
    .book-card {
      background: white; border-radius: 12px; padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); cursor: pointer;
      display: flex; flex-direction: column; align-items: center;
      transition: transform 0.2s;
    }
    .book-card:hover { transform: scale(1.02); }
    .book-card img {
      width: 100%; height: 250px; object-fit: contain; border-radius: 8px;
      background: #f5f5f5;
    }
    .book-card h3 { margin: 10px 0 5px; font-size: 16px; text-align: center; }
    .book-card p { font-size: 13px; color: #555; text-align: center; }

    /* 로딩 */
    .loading { text-align: center; margin: 40px auto; color: #555; }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid #e5e7eb;
      border-top: 4px solid #1a73e8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden { display: none; }

    /* 상단 네비 */
    .nav { margin-bottom: 20px; text-align: center; }
    .nav a { margin: 0 10px; text-decoration: none; color: #1a73e8; font-weight: bold; }
  </style>
</head>
<body>
  <h1>📚 도서 리스트</h1>

  <div class="nav">
    <a href="index.html">🏠 홈</a>
  </div>

  <!-- 필터 버튼 -->
  <div class="toolbar" id="filterBar">
    <button onclick="filterBooks('all')">전체보기</button>
  </div>

  <!-- 로딩 -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>로딩 중입니다...</p>
  </div>

  <!-- 도서 카드 리스트 -->
  <div id="bookList" class="grid hidden"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbygL5W_rVDTMkPIjLiSjDVN5nxRaZgHTIW3vbJgTgOL_Z_IwLF4k97VEd1bQNfxqAs1_A/exec";

    let books = [];

    async function fetchBooks() {
      try {
        const res = await fetch(API_URL + "?action=getBooks");
        books = await res.json();

        buildFilterButtons(books);
        renderBooks(books);

      } catch (e) {
        document.getElementById("loading").innerHTML = "<p>❌ 데이터를 불러오는 중 오류가 발생했습니다.</p>";
      }
    }

    function buildFilterButtons(data) {
      const categories = new Set();
      const levels = new Set();

      data.forEach(b => {
        (b.category || "").split(",").forEach(c => c.trim() && categories.add(c.trim()));
        (b.level || "").split(",").forEach(l => l.trim() && levels.add(l.trim()));
      });

      const bar = document.getElementById("filterBar");

      categories.forEach(c => {
        const btn = document.createElement("button");
        btn.textContent = "카테고리: " + c;
        btn.onclick = () => filterBooks(c);
        bar.appendChild(btn);
      });

      levels.forEach(l => {
        const btn = document.createElement("button");
        btn.textContent = "레벨: " + l;
        btn.onclick = () => filterBooks(l);
        bar.appendChild(btn);
      });
    }

    function filterBooks(keyword) {
      if (keyword === "all") {
        renderBooks(books);
      } else {
        const filtered = books.filter(b =>
          (b.category && b.category.includes(keyword)) ||
          (b.level && b.level.includes(keyword))
        );
        renderBooks(filtered);
      }
    }

    function renderBooks(list) {
      const container = document.getElementById("bookList");
      container.innerHTML = "";

      if (list.length === 0) {
        container.innerHTML = "<p>등록된 도서가 없습니다.</p>";
      }

      list.forEach(book => {
        const card = document.createElement("div");
        card.className = "book-card";
        card.onclick = () => viewDetail(book.title);

        card.innerHTML = `
          <img src="${book.cover}" alt="${book.title}">
          <h3>${book.title}</h3>
          <p>${book.author || ""} / ${book.publisher || ""}</p>
        `;

        container.appendChild(card);
      });

      document.getElementById("loading").classList.add("hidden");
      container.classList.remove("hidden");
    }

    function viewDetail(title) {
      window.location.href = `book-detail.html?title=${encodeURIComponent(title)}`;
    }

    fetchBooks();
  </script>
</body>
</html>
