<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookMap — 도서 리스트</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; background: #fafafa; color: #333; }
    h1 { margin-bottom: 14px; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; }
    button.filter { padding: 6px 12px; border: 1px solid #ddd; border-radius: 20px; background: #fff; cursor: pointer; }
    button.filter.active { background: #1a73e8; color: #fff; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
    .book-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 12px; cursor: pointer; transition: transform 0.2s; }
    .book-card:hover { transform: translateY(-4px); }
    .book-card img { width: 100%; height: 180px; object-fit: contain; background: #f9f9f9; border-radius: 8px; }
    .nav { margin: 20px 0; }
    .nav a { margin-right: 10px; text-decoration: none; color: #1a73e8; }
    .loading { text-align: center; margin-top: 40px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>도서 리스트</h1>
  <div class="nav">
    <a href="index.html">🏠 메인으로</a>
  </div>

  <!-- 필터 영역 -->
  <div id="category-filters" class="toolbar"></div>
  <div id="level-filters" class="toolbar"></div>

  <!-- 도서 리스트 -->
  <div id="book-list" class="grid"></div>

  <!-- 로딩 -->
  <div id="loading" class="loading hidden">로딩 중입니다...</div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbygL5W_rVDTMkPIjLiSjDVN5nxRaZgHTIW3vbJgTgOL_Z_IwLF4k97VEd1bQNfxqAs1_A/exec";
    let books = [];
    let activeCategory = null;
    let activeLevel = null;

    function showLoading() {
      document.getElementById("loading").classList.remove("hidden");
    }
    function hideLoading() {
      document.getElementById("loading").classList.add("hidden");
    }

    async function loadBooks() {
      showLoading();
      try {
        const res = await fetch(API_URL + "?action=getBooks");
        const data = await res.json();
        books = data;
        renderFilters();
        renderBooks();
      } catch (e) {
        console.error("Error loading books", e);
      } finally {
        hideLoading();
      }
    }

    function renderFilters() {
      const categories = [...new Set(books.flatMap(b => (b.category ? b.category.split(",") : [])))];
      const levels = ["입문", "초급", "중급", "고급", "전문"];

      const catContainer = document.getElementById("category-filters");
      catContainer.innerHTML = `<strong>카테고리:</strong>`;
      categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.className = "filter";
        btn.innerText = cat.trim();
        btn.onclick = () => {
          activeCategory = activeCategory === cat ? null : cat;
          renderBooks();
          renderFilters();
        };
        if (activeCategory === cat) btn.classList.add("active");
        catContainer.appendChild(btn);
      });

      const levelContainer = document.getElementById("level-filters");
      levelContainer.innerHTML = `<strong>레벨:</strong>`;
      levels.forEach(lv => {
        const btn = document.createElement("button");
        btn.className = "filter";
        btn.innerText = lv;
        btn.onclick = () => {
          activeLevel = activeLevel === lv ? null : lv;
          renderBooks();
          renderFilters();
        };
        if (activeLevel === lv) btn.classList.add("active");
        levelContainer.appendChild(btn);
      });
    }

    function renderBooks() {
      const list = document.getElementById("book-list");
      list.innerHTML = "";
      let filtered = books;
      if (activeCategory) {
        filtered = filtered.filter(b => b.category && b.category.includes(activeCategory));
      }
      if (activeLevel) {
        filtered = filtered.filter(b => b.level && b.level.includes(activeLevel));
      }
      if (filtered.length === 0) {
        list.innerHTML = "<p>해당 조건의 도서가 없습니다.</p>";
        return;
      }
      filtered.forEach(book => {
        const card = document.createElement("div");
        card.className = "book-card";
        card.onclick = () => viewDetail(book.title);

        card.innerHTML = `
          <img src="${book.cover || ''}" alt="${book.title}">
          <h3>${book.title}</h3>
          <p>${book.author || ''} / ${book.publisher || ''}</p>
        `;
        list.appendChild(card);
      });
    }

    function viewDetail(title) {
      window.location.href = "detail.html?title=" + encodeURIComponent(title);
    }

    loadBooks();
  </script>
</body>
</html>
